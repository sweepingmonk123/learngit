= 数据开发
//文档整体配置
include::99_documentSetting.adoc[]

数据开发页面包括实时任务开发与离线任务开发，任务开发模块是根据业务需求，设计数据计算流程并编码的模块。下面分为实时任务开发与离线任务开发2个模块分别介绍。


== 离线任务开发

离线任务开发模块主要是设计数据计算流程，并实现为多个相互依赖的任务，供调度系统自动执行的主要操作页面。

**对象**

在数据开发阶段，RD-OS提供了4种对象：任务、脚本、资源和函数。它们之间的项目关系如下图所示：

image::images\05_RD-OSHelp_UserGuide_DataDevelopment-adee5.png[]

每个对象的说明如下：

* 任务：数据开发的主要对象，包含周期属性和依赖关系，是数据计算的主要载体，支持多种类型的任务和节点适应不同场景，详情请参见<<任务类型概述>>。
* 脚本：数据开发的辅助对象，不包含周期属性和依赖关系，主要用于实现非周期的临时数据处理，如临时表的增删改等，详情请参见<<脚本开发>>。
* 函数和资源：任务中的代码运行时需要引用的一些文件和计算函数，在任务正式执行前需要上传，详情请参见<<资源管理和函数使用>>。


**流程**

一个任务的开发和使用流程如下图所示：

image::images\05_RD-OSHelp_UserGuide_DataDevelopment-15f79.png[]

**任务运行说明**

由流程的介绍可知，RD-OS提供了3种运行方式，以使任务中的计算语句生效，适用场景和限制条件如下：

[cols="1, 1, 1, 1, 3, 2", options="header"]
|===
|操作
|触发方式
|运维中心是否有实例生成
|调度属性情况
|适用场景
|特殊说明
|页面直接运行
|手动触发
|否
|不受调度周期和依赖关系影响
|适用于代码调试阶段，无需保存提交
|支持脚本和任务，但任务、脚本类型仅支持SQL1种
|系统自动运行
|系统触发
|是
|受调度周期和依赖关系影响
|是使用RD-OS实现数据自动计算的主要方式，需要运维人员在运维中心维护所有周期实例按序成功执行
|仅支持任务，不支持脚本，且使用最新提交的版本
|补数据运行
|手动触发
|是
|受调度周期和依赖关系影响
|是对系统自动运行方式的补充，部分任务由于新建或者出错，需要触发今天之前一段时间的数据计算时使用该功能
|仅支持任务，且使用最新提交的版本
|===


===	任务开发
在任务开发页面，切换至离线任务标签，点击“新建离线任务”，并补充如下信息：

* 任务名称，填写规则与<< 实时任务的创建 >>中的描述类似
* 任务类型：可选择MR、SQL或数据同步任务；
* 不同任务类型对应的信息：若选择了MR任务，则还需要补充“资源”，“mainClass”、“参数”信息；
* 存储位置，填写规则与<<实时任务的创建>>中的描述类似；

点击“创建”后，即可创建此离线任务。

===	任务类型
* 创建基于SQL的离线任务后，系统会自动打开SQL任务编辑页面；或在左侧离线任务列表中双击一个SQL任务，也可以打开SQL任务编辑页面。
* 在SQL编辑区域可输入任务代码，在“任务属性”侧边栏查看、编辑任务基本信息，在“任务参数”中查看、修改SQL任务参数信息，在“调度依赖”侧边栏配置本任务的调度周期、任务间的依赖关系等信息。

[[batchJobMR]]
===	离线任务开发（MR）
* 创建基于MR的离线任务后，系统会自动打开MR任务编辑页面；或在左侧离线任务列表中双击一个MR任务，也可以打开MR任务编辑页面。
* 在MR任务编辑区域可修改任务名称、关联资源、mainClass、参数、存储位置、描述等信息。在“任务属性”侧边栏可查看、编辑任务基本信息，在“调度依赖”侧边栏配置本任务的调度周期、任务间的依赖关系等信息。

[[batchJobSync]]
===	调度属性的配置
创建数据同步任务后，或在左侧离线任务列表中双击一个数据同步任务，都可以打开编辑页面。

. 在数据同步任务编辑页面中，用户需要分为数据来源、目标、字段映射、通道控制、预览保存，共5个步骤完成参数配置。
. 数据同步任务的侧边栏与SQL、MR任务类似，在“任务属性”侧边栏可查看、编辑任务基本信息，在“调度依赖”侧边栏配置本任务的调度周期、任务间的依赖关系等信息。

下面详细描述数据同步任务的配置流程：

. **Step1:数据来源**
.. 选择数据源类型：MySQL、Oracle或HDFS；
.. 选择表：即数据源中的哪张表；
... 若选择了MySQL或Oracle，还可以编写数据过滤规则footnoteref:[过滤规则, where 条件即针对源头数据筛选条件，根据指定的 column、table、where 条件拼接 SQL 进行数据抽取 。利用 where 条件可进行全量同步和增量同步，具体说明如下：
1）全量同步：第一次做数据导入时通常为全量导入，可不用设置where条件
2）增量同步：增量导入在实际业务场景中，往往会选择当天的数据进行同步，通常需要编写where条件语句，请先确认表中描述增量字段（时间戳）为哪一个。如tableA描述增量的字段为create_time，那么在where条件中编写create_time >${yesterday}，在参数配置中为其参数赋值即可]、切分键规则footnoteref:[切分键,切分键：根据配置的字段进行数据分片，实现并发读取，MySQL支持数值型切分键，Oracle支持数值型、字符串类型切分键]；
... 若选择了HDFS，还需要补充分区信息footnoteref:[分区信息,分区信息：分区配置支持调度参数，比如分区pt值配置为${bdp.system.bizdate}]；
.. 数据预览：完成以上配置后，在“数据预览”中可查看选中数据库下、选中表内的3条数据；

. **Step2：选择目标**
.. 选择数据同步目标类型：MySQL、Oracle或HDFS；
.. 选择表：即要把数据同步至哪张表；
... 若选择了MySQL或Oracle，还可以补充导入前准备语句footnoteref:[导入前准备语句,导入前准备语句：导入数据前，可执行SQL执行脚本做准备工作]、导入后准备语句footnoteref:[导入后准备语句,导入后准备语句：导入数据后，可执行SQL执行脚本做辅助工作]、主键冲突处理规则footnoteref:[主键冲突处理规则,主键冲突处理规则：即发生主键冲突之后对应的处理动作]；
... 若选择了HDFS，还需要补充分区信息footnoteref:[分区信息]、清理规则footnoteref:[清理规则,清理规则：可在2种清理规则中选择1种，{写入前清理已有数据 Insert Overwrite；写入前保留已有数据 Insert Into}]；

. **Step3：字段映射** +
字段映射是在数据源与数据目标之间建立精确的字段对应关系。 +
在左侧数据源表与右侧的数据目标表之间，通过连线来建立映射关系。或进行“同行映射”，将源表与同一行的目标表字段映射映射起来。

. **Step4：通道控制** +
通道控制可配置数据同步任务的传输速度，用户可配置作业速率上限（1M/S~10M/S），同时可配置数据同步过程中对脏数据的容忍程度，若超过配置的条数限制，则自动停止任务。

. **Step5：预览保存** +
最后一个步骤是对以上4步所配置的信息的预览确认，同时可对各步骤中配置的参数进行保存。

[[batchScheduleConfig]]
====	离线任务的调度依赖配置
离线任务的调度依赖配置是重要功能，因此单独成一节介绍。 +
对于离线任务（包括SQL、MR、数据同步），可在“调度依赖”侧边栏，可配置此任务的调度周期等参数，具体包括如下内容：

* **调度属性** +
调度属性的配置包括如下内容：此任务接受调度还是停止调度？此任务在什么时间生效？多长时间间隔运行一次？具体什么时候运行？具体包括： +

. 调度状态 +
选中“停止”，表示此任务停止调度，不会进行实际的计算（通常此功能用于暂时不需要运行，但也不想删除的任务）；
若勾选“停止”，任务每天仍会产生实例，但调度时会直接返回失败状态，不会真正运行任务逻辑。
. RD-OS的任务实例说明 +
RD-OS在每天22:00统一生成第二天所有需要的任务实例，基于以上设计，任务开发时需要注意任务的提交时间，这里以一个天周期调度任务A为例： +
image:images\任务实例产生与运行图示.png[alt="任务实例产生与运行图示",width="500", align=left] +
任务A基本信息：调度周期：1天；具体调度时间：8:00； +
1）若您在1月1日21:00提交A任务，RD-OS会在当天22:00产生A任务的实例，并会在1月2日8:00第一次运行； +
2）若您在1月1日23:00提交A任务，由于RD-OS已经在22:00产生了1月2日的所有实例，A任务在1月2日将不会运行。A任务的实例将会在1月2日22:00产生，并在1月3日第一次运行。
. 生效日期：任务只在生效日期内执行；
. 调度周期：分为{天；周；月；小时；分钟}，若选中“天”，则表示此任务每天执行一次；
. 起调时间：用户设定调度周期后，还需要设定具体在哪个时刻点启动任务。根据用户选择的调度周期不同，起调时间需要配置不同的参数：

[cols="1, 5", options="header"]
|===
|调度周期
|起调时间配置
|日
a|
配置“具体时间”：

* 小时：单选下拉列表，00-23，默认选中00
* 分钟：单选下拉列表，00-59，默认选中00

|周
a|
需配置“选择时间”和“具体时间”：

* 选择时间：复选下拉列表{星期一；星期二；……星期日}，可复选，默认选中“星期一”；
* 具体时间：同“调度周期-日”相同；

|月
a|
需配置“选择时间”和“具体时间”：

* 选择时间：复选下拉列表{每月最后一天；每月1号；每月2号；……每月31号}，可复选，默认选中“星期一”；
* 具体时间：同“调度周期-日”相同；

|小时
a|
当调度周期切换到非天级调度时，节点起调时间将不可选，并与任务保持一致！ +
需配置“开始时间”、“结束时间”和“间隔时间”：

* 开始时间、结束时间：同“调度周期-日”类似，小时可选择00-23，分钟不可选，开始时间的分钟为0，结束时间的分钟为59；
* 间隔时间：单选下拉列表{1小时；2小时……23小时}，默认选中1小时；
* 开始时间，应早于结束时间，若不符合，需提示用户“开始时间应早于结束时间”；

|分钟
a|
当调度周期切换到非天级调度，节点起调时间将不可选，并与任务保持一致！ +
需配置“开始时间”、“结束时间”和“间隔时间”：

* 开始时间、结束时间：同“调度周期-小时”相同；
* 间隔时间：单选下拉列表{5分钟；10分钟；……55分钟}，默认选中5分钟；
* 开始时间，应早于结束时间，若不符合，需提示用户“开始时间应早于结束时间”；
|===

* **任务间依赖**

若某任务B必须在任务A完成后运行，则A为B的上游任务，这种依赖关系可通过如下方式配置：在“上游任务”输入框，输入任务关键字，在列出的可选任务中选中某个任务，此任务被添加到上游任务列表中，即完成了A、B间的依赖关系配置。

* **跨周期依赖**

跨周期依赖配置有两类：

. 自依赖，等待上一调度周期结束，才能继续运行：假设设定A任务每天1:00运行，设定为自依赖后，A任务在3月1日未运行成功，则在3月2日不会运行。
. 不依赖上一调度周期：若A任务在3月1日未运行成功，则在3月2日会产生新的实例并运行。

NOTE: 关于任务间的依赖关系、任务的跨周期依赖配置，请参考<<RD-OS开发指南#离线计算任务开发>> +

====	函数管理

在离线任务开发中，SQL等任务经常需要使用自建函数，RD-OS支持用户自建函数（UDF-User Defined Function）的管理功能。

* **新建函数**

在函数管理的“新建函数”icon，在弹窗中输入如下信息：

. #函数名称；#
. 类名；
. 资源；
. 用途；
. 命令格式；
. 参数说明；
. 存储位置；

保存后，函数管理模块自动刷新，即可看到新建的函数。

[start=2]
* **自建函数的应用**

请参考<<RD-OS开发指南#离线计算任务开发>>

===	资源管理

在进行任务开发的过程中，SQL/MR任务都可能需要关联资源才能正常运行，因此需要对资源进行上传、删除、修改等操作。 +
在任务开发页面，实时任务、离线任务都有资源管理，二者操作方式相同，但两个资源管理属于不同的范畴，不能混用。

* **资源上传**

点击“上传资源”icon，输入资源名称、资源类型、选择待上传的文件，设定存储位置并保存后，即可看到上传的资源。

* **资源的应用**

通常在新建任务、编辑任务时进行资源的关联应用。

* **资源删除**

在某个资源的右键菜单中选择“删除”即可。

NOTE: 若此资源在某任务中得到了应用，且此任务处于“运行”状态时，用户不能对其删除否则会导致任务执行失败

===	目录管理

RD-OS的任务、资源、函数等内容均通过目录的形式组织，因此目录管理适用于各个模块（包括实时/离线任务管理、资源管理、函数管理等）。

* **新建目录**

在实时任务、离线任务、资源管理、函数管理等各个模块中选择“新建目录”icon，补充目录名称、存储位置即可。

* **其他支持的操作**

除新建目录外，还可以进行移动目录位置、对目录重命名等操作。


=== 调度参数

当离线任务中需要动态获取业务日期、调度时间等信息时，可使用RD-OS提供的自定义变量来实现。此功能通常应用于以下场景：某任务为每天调度一次，需要统计昨天的历史数据，那么可以在SQL或MR任务中添加业务日期变量，此变量会随着系统时间而变化，即实现“今天的任务处理昨天的数据”。

[.lead ]
**业务日期变量**

变量引用方式：
[source, SQL]
${bdp.system.bizdate}

当SQL或MR任务执行时，会根据当前时间动态获取业务日期，将此变量替换为调度周期减1天，格式为：YYYYMMDD

* **SQL任务的操作方式**

假设当前日期为2017-01-01，调度周期为“日”，调度时间为09:00，SQL内容如下。
[source, SQL]
SELECT * FROM t where date = ${bdp.system.bizdate}

则此任务在2017-01-02 09:00进行实际运行时，其SQL语句会按照如下内容执行：

[source, SQL]
SELECT * FROM t where date = 20170101

* **MR任务的操作方式**

用户在创建/编辑MR任务时，“参数”字段中填入本变量，并在MR程序中需要获取main函数中的args参数，此参数中包含了变量的实际值：


[.lead ]
**调度时间变量**

类似业务日期变量，引用方式为：
[source, SQL]
${bdp.system.cyctime}

当SQL或MR任务执行时，会根据当前时间动态获取调度时间，格式为：YYYYMMDDHHMMSS。同样类似与业务日期变量，其在SQL和MR任务中的使用方式类似。



== 实时任务开发
实时任务的开发包括实时任务创建、基于SQL的实时任务开发和基于MR的实时任务开发3大部分。本节首先对实时任务进行简要介绍，并对利用RD-OS进行实时任务开发进行说明。


=== 实时任务简介
在大数据开发领域，通常根据数据的不同性质，将任务划分为实时计算与离线计算，以温度传感器的场景举例：

例如：某城市安装了大量的温度传感器，每个传感器每隔1min上传一次采集到的温度信息，由气象中心统一汇总，每隔10min更新一次各个地区的温度，这些数据是一直源源不断的产生的，且不会停止。实时计算就主要用于“数据源源不断的产生，而且不会停止，需要以最小的延迟获得计算结果”的场景

=== 支持的数据源
在实时任务中，RD-OS目前只支持以**kafka**作为数据源，用户只需要在SQL或MR任务中设定kafka地址、分区等信息即可读取数据进行计算。

=== 任务的创建
在任务开发页面，切换至实时任务标签，在“新建实时任务”icon后，补充任务名称、任务类型等信息，保存即可。
目前支持创建基于MR的实时任务，和基于SQL的实时任务，创建两类任务均需要关联相关资源，并设定存储位置。

* 任务名称：即此任务的名称，支持字母、数字、下划线，不超过20个字符。
* 任务类型：可选择SQL或MR，SQL任务是基于Flink SQL的实时计算任务，MR任务是基于Java的Flink计算任务。SQL任务适合比较简单的数据统计，MR任务可支持逻辑较复杂的计算，具体情况请参考 <<realTimeJobHandbook>>或
https://flink.apache.org/[Flink官方文档]
* 资源：此处的资源即用户基于Flink API编写的Java代码。若为SQL任务，若需要使用自定义函数时，则需要关联资源；若为MR任务，则必须关联资源，以保证任务的运行。
* 存储位置：即此任务在页面左侧的任务存储结构中的位置。
* 描述：此任务的描述，可输入长度不超过128位的任意字符。

==== 实时任务开发（SQL）
创建基于SQL的实时任务后，系统会自动打开SQL任务编辑页面；或双击一个实时SQL任务，也可以打开SQL任务编辑页面。

* **Flink SQL简介**

* **读取数据源**

* **如何编写Flink SQL**

* **计算结果的输出**

* **创建UDF**

NOTE: 关于如何编写Flink SQL的详细资料，请参考 <<realTimeJobHandbook>>



==== 实时任务开发（MR）
创建基于MR的实时任务后，系统会自动打开MR任务编辑页面；或在左侧实时任务列表中双击一个MR任务，也可以打开MR任务编辑页面。 +
在MR任务编辑区内，可修改任务名称、关联的资源、存储位置等信息，同样可以在“任务属性”侧边栏查看、编辑任务基本信息，在“任务参数”侧边栏查看、修改任务参数信息。
关于如何编写Flink MR等信息，请参考 <<realTimeJobHandbook>>

==== 任务参数配置
